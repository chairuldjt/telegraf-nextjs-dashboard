# ==========================================
# GLOBAL AGENT CONFIG
# ==========================================
[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "60s"
  flush_jitter = "5s"
  hostname = "" # Biarkan kosong agar otomatis pakai nama PC Windows 11
  omit_hostname = false

# ==========================================
# INPUT PLUGINS (Apa yang mau dicapture)
# ==========================================

# 1. Capture CPU
[[inputs.cpu]]
  percpu = false
  totalcpu = true
  collect_cpu_time = false
  report_active = false

# 2. Capture RAM
[[inputs.mem]]
  # Tidak butuh config khusus

# 3. Capture System (Uptime, Load)
[[inputs.system]]


# ==========================================
# INPUT: NETWORK INFO (IP & MAC)
# ==========================================
[[inputs.exec]]
  # MENGGUNAKAN TRIPLE QUOTE (''') AGAR TIDAK ERROR SYNTAX
  commands = ['''powershell -Command "Get-NetAdapter | Where-Object {$_.Status -eq 'Up' -and $_.PhysicalMediaType -ne $null} | Select-Object -First 1 -Property MacAddress, @{Name='IP_Address';Expression={($_ | Get-NetIPAddress -AddressFamily IPv4).IPAddress}} | ConvertTo-Json"''']

  # Timeout jika perintah macet
  timeout = "5s"

  # Format data yang dihasilkan PowerShell adalah JSON
  data_format = "json"

  # Kita paksa simpan data ini ke tabel bernama "client_network"
  name_override = "client_network"

  # PENTING: Beritahu Telegraf bahwa field ini adalah string (teks), bukan angka
  json_string_fields = ["MacAddress", "IP_Address"]
  
# ==========================================
# OUTPUT PLUGINS (Kirim ke PostgreSQL)
# ==========================================

[[outputs.postgresql]]
  # Format koneksi: postgres://user:password@ip_server:port/nama_db
  connection = "postgres://telegraf_user:Donykt3st@172.16.3.36:5432/monit_pcklien?sslmode=disable"
  
  # Schema tempat tabel akan dibuat (default: public)
  schema = "public"
  
  # Apakah Telegraf boleh membuat tabel otomatis? (Disarankan true untuk awal)
  #create_templates = true
  
  # Opsional: Menambahkan tag sebagai kolom terpisah (Biar mudah di-query SQL)
  #tags_as_foreign_keys = false
  #cached_tag_key_name = "tag_id"
  #cached_tag_value_name = "tag_value"